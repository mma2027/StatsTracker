{% extends "base.html" %}

{% block title %}Demo Panel - StatsTracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üéÆ Demo Panel</h1>
    <p>Run essential operations for testing and demonstrations</p>
</div>

<div class="demo-sections">
    <!-- Stats Update Section -->
    <section class="demo-section">
        <h2>Update All Stats</h2>
        <p>Re-fetch all player stats from NCAA, ClubLocker, TFRR, and CricClubs. This will take 5-10 minutes.</p>

        <button id="btn-update-stats" class="btn btn-primary btn-lg">
            üîÑ Update All Stats
        </button>

        <div id="update-status" class="status-message" style="display: none;"></div>
        <div id="update-progress" class="progress-box" style="display: none;">
            <h4>Progress:</h4>
            <div id="update-current-item" class="current-item"></div>
        </div>
    </section>

    <!-- Gameday Simulator Section -->
    <section class="demo-section">
        <h2>Simulate Gameday Checker</h2>
        <p>Check for games on a specific date and see what email would be sent.</p>

        <div class="form-group">
            <label for="gameday-date">Select Date:</label>
            <input type="date" id="gameday-date" class="input-date" value="{{ today }}">
        </div>

        <button id="btn-simulate-gameday" class="btn btn-primary btn-lg">
            üìÖ Simulate Gameday
        </button>

        <div id="gameday-status" class="status-message" style="display: none;"></div>

        <!-- Results Display -->
        <div id="gameday-results" class="results-container" style="display: none; margin-top: 1.5rem;">
            <h3>Results:</h3>

            <div class="results-summary">
                <div class="summary-item">
                    <strong>Games:</strong> <span id="games-count">0</span>
                </div>
                <div class="summary-item">
                    <strong>Milestone Alerts:</strong> <span id="milestones-count">0</span>
                </div>
                <div class="summary-item">
                    <strong>Sports:</strong> <span id="sports-list">-</span>
                </div>
            </div>

            <div class="results-section">
                <h4>Games Scheduled:</h4>
                <div id="games-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div class="results-section">
                <h4>Milestone Proximities:</h4>
                <div id="milestones-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div class="results-section">
                <h4>Email Preview:</h4>
                <div class="email-subject" style="margin-bottom: 1rem;">
                    <strong>Subject:</strong> <span id="email-subject"></span>
                </div>
                <iframe id="email-preview" class="email-preview" style="width: 100%; height: 500px; border: 2px solid #e0e0e0; border-radius: 4px; background: white;"></iframe>
            </div>

            <button id="btn-send-test-email" class="btn btn-secondary" style="margin-top: 1rem;">
                ‚úâÔ∏è Send Test Email
            </button>
            <div id="email-send-status" class="status-message" style="display: none;"></div>
        </div>
    </section>
</div>

<script>
// Today's date for default
const today = new Date().toISOString().split('T')[0];
document.getElementById('gameday-date').value = today;

// Update Stats Button with Real-Time Progress
document.getElementById('btn-update-stats').addEventListener('click', async function() {
    const button = this;
    const status = document.getElementById('update-status');
    const progressBox = document.getElementById('update-progress');
    const currentItem = document.getElementById('update-current-item');

    button.disabled = true;
    button.textContent = '‚è≥ Updating... (10-15 minutes)';
    status.style.display = 'block';
    status.className = 'status-message status-loading';
    progressBox.style.display = 'block';

    // Generate unique session ID
    const sessionId = 'update-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

    // Connect to SSE endpoint for real-time progress
    const eventSource = new EventSource(`/api/progress/${sessionId}`);
    let lastMessageTime = Date.now();
    let errorCount = 0;
    let completedSuccessfully = false;

    const checkConnection = setInterval(() => {
        const timeSinceLastMessage = Date.now() - lastMessageTime;
        if (timeSinceLastMessage > 30000) {
            console.warn('No activity for 30 seconds, connection may be dead');
        }
    }, 5000);

    eventSource.onmessage = function(event) {
        lastMessageTime = Date.now();
        const message = JSON.parse(event.data);

        if (message.type === 'info' || message.type === 'fetch') {
            currentItem.textContent = message.message;
        } else if (message.type === 'warning') {
            currentItem.textContent = '‚ö†Ô∏è ' + message.message;
        } else if (message.type === 'error') {
            currentItem.textContent = '‚ùå ' + message.message;
            status.className = 'status-message status-error';
            status.textContent = `‚ùå Error: ${message.message}`;
            button.textContent = 'üîÑ Update All Stats';
            button.disabled = false;
            progressBox.style.display = 'none';
            clearInterval(checkConnection);
            eventSource.close();
        } else if (message.type === 'success') {
            completedSuccessfully = true;
            currentItem.textContent = message.message;
            status.className = 'status-message status-success';
            status.textContent = '‚úÖ All stats updated successfully!';
            button.textContent = '‚úÖ Update Complete';
            clearInterval(checkConnection);
            setTimeout(() => {
                progressBox.style.display = 'none';
                eventSource.close();
            }, 2000);
        }
    };

    eventSource.onerror = function(err) {
        if (completedSuccessfully) {
            console.log('SSE stream closed after successful completion (expected)');
            eventSource.close();
            return;
        }

        errorCount++;
        console.error('SSE error (count: ' + errorCount + '):', err);

        if (errorCount > 2) {
            currentItem.textContent = 'Connection error';
            status.className = 'status-message status-error';
            status.textContent = '‚ùå Connection lost - try refreshing the page';
            button.textContent = 'üîÑ Update All Stats';
            button.disabled = false;
            progressBox.style.display = 'none';
            clearInterval(checkConnection);
            eventSource.close();
        }
    };

    try {
        const response = await fetch('/api/update-stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Update failed');
        }
    } catch (error) {
        currentItem.textContent = 'Failed to start update';
        status.className = 'status-message status-error';
        status.textContent = `‚ùå Error: ${error.message}`;
        button.textContent = 'üîÑ Update All Stats';
        button.disabled = false;
        progressBox.style.display = 'none';
        eventSource.close();
    }
});

// Simulate Gameday Button
document.getElementById('btn-simulate-gameday').addEventListener('click', async function() {
    const button = this;
    const status = document.getElementById('gameday-status');
    const results = document.getElementById('gameday-results');
    const date = document.getElementById('gameday-date').value;

    button.disabled = true;
    button.textContent = '‚è≥ Simulating...';
    status.style.display = 'block';
    status.className = 'status-message status-loading';
    status.textContent = 'Checking games and milestones...';
    results.style.display = 'none';

    try {
        const response = await fetch('/api/simulate-gameday', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: date })
        });

        const data = await response.json();

        if (data.success) {
            status.className = 'status-message status-success';
            status.textContent = '‚úÖ Simulation complete!';

            // Update summary
            document.getElementById('games-count').textContent = data.games_count;
            document.getElementById('milestones-count').textContent = data.proximities_count;
            document.getElementById('sports-list').textContent = data.sports_with_games.join(', ') || 'None';

            // Display games
            const gamesList = document.getElementById('games-list');
            if (data.games.length > 0) {
                gamesList.innerHTML = data.games.map(game => `
                    <div class="result-item">
                        <strong>${game.sport}</strong> vs ${game.opponent} (${game.location})<br>
                        Time: ${game.time}
                    </div>
                `).join('');
            } else {
                gamesList.innerHTML = '<p class="empty">No games scheduled</p>';
            }

            // Display milestones
            const milestonesList = document.getElementById('milestones-list');
            if (data.proximities.length > 0) {
                milestonesList.innerHTML = data.proximities.map(prox => `
                    <div class="result-item">
                        <strong>${prox.player_name}</strong><br>
                        ${prox.milestone}<br>
                        Current: ${prox.current} | Target: ${prox.target} | Remaining: ${prox.remaining} (${prox.percentage})
                    </div>
                `).join('');
            } else {
                milestonesList.innerHTML = '<p class="empty">No players close to milestones</p>';
            }

            // Display email preview
            document.getElementById('email-subject').textContent = data.email_subject;
            const iframe = document.getElementById('email-preview');
            iframe.contentDocument.open();
            iframe.contentDocument.write(data.email_html);
            iframe.contentDocument.close();

            results.style.display = 'block';
            button.textContent = 'üìÖ Simulate Gameday';
            button.disabled = false;
        } else {
            throw new Error(data.error || 'Simulation failed');
        }
    } catch (error) {
        status.className = 'status-message status-error';
        status.textContent = `‚ùå Error: ${error.message}`;
        button.textContent = 'üìÖ Simulate Gameday';
        button.disabled = false;
    }
});

// Send Test Email Button
document.getElementById('btn-send-test-email').addEventListener('click', async function() {
    const button = this;
    const status = document.getElementById('email-send-status');
    const date = document.getElementById('gameday-date').value;

    if (!confirm('Send test email to configured recipients?')) {
        return;
    }

    button.disabled = true;
    button.textContent = '‚è≥ Sending...';
    status.style.display = 'block';
    status.className = 'status-message status-loading';
    status.textContent = 'Sending email...';

    try {
        const response = await fetch('/api/send-test-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: date })
        });

        const data = await response.json();

        if (data.success) {
            status.className = 'status-message status-success';
            status.textContent = '‚úÖ Email sent successfully!';
        } else {
            throw new Error(data.error || 'Email send failed');
        }
    } catch (error) {
        status.className = 'status-message status-error';
        status.textContent = `‚ùå Error: ${error.message}`;
    } finally {
        button.textContent = '‚úâÔ∏è Send Test Email';
        button.disabled = false;
    }
});
</script>
{% endblock %}
