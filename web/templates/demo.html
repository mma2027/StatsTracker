{% extends "base.html" %}

{% block title %}Demo Panel - StatsTracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üéÆ Demo Panel</h1>
    <p>Run essential operations for testing and demonstrations</p>
</div>

<div class="demo-sections">
    <!-- Stats Update Section -->
    <section class="demo-section">
        <h2>Update All Stats</h2>
        <p>Re-fetch all player stats from NCAA, ClubLocker, TFRR, and CricClubs. This will take 5-10 minutes.</p>

        <button id="btn-update-stats" class="btn btn-primary btn-lg">
            üîÑ Update All Stats
        </button>

        <div id="update-status" class="status-message" style="display: none;"></div>
        <div id="update-progress" class="progress-box" style="display: none;">
            <h4>Progress:</h4>
            <div id="update-current-item" class="current-item"></div>
        </div>
    </section>

    <!-- Gameday Simulator Section -->
    <section class="demo-section">
        <h2>Simulate Gameday Checker</h2>
        <p>Check for games on a specific date and see what email would be sent.</p>

        <div class="form-group">
            <label for="gameday-date">Select Date:</label>
            <input type="date" id="gameday-date" class="input-date" value="{{ today }}">
        </div>

        <button id="btn-simulate-gameday" class="btn btn-primary btn-lg">
            üìÖ Simulate Gameday
        </button>

        <div id="gameday-status" class="status-message" style="display: none;"></div>

        <!-- Results Display -->
        <div id="gameday-results" class="results-container" style="display: none; margin-top: 1.5rem;">
            <h3>Results:</h3>

            <div class="results-summary">
                <div class="summary-item">
                    <strong>Games:</strong> <span id="games-count">0</span>
                </div>
                <div class="summary-item">
                    <strong>Milestone Alerts:</strong> <span id="milestones-count">0</span>
                </div>
                <div class="summary-item">
                    <strong>PR Breakthroughs:</strong> <span id="pr-count">0</span>
                </div>
                <div class="summary-item">
                    <strong>Sports:</strong> <span id="sports-list">-</span>
                </div>
            </div>

            <div class="results-section">
                <h4>Games Scheduled:</h4>
                <div id="games-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div class="results-section">
                <h4>Milestone Proximities:</h4>
                <div id="milestones-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div class="results-section">
                <h4>üéâ PR Breakthroughs (Sample Data):</h4>
                <div id="pr-list"></div>
            </div>

            <div class="results-section">
                <h4>Email Preview:</h4>
                <div class="email-subject" style="margin-bottom: 1rem;">
                    <strong>Subject:</strong> <span id="email-subject"></span>
                </div>
                <iframe id="email-preview" class="email-preview" style="width: 100%; height: 500px; border: 2px solid #e0e0e0; border-radius: 4px; background: white;"></iframe>
            </div>

            <button id="btn-send-test-email" class="btn btn-secondary" style="margin-top: 1rem;">
                ‚úâÔ∏è Send Test Email
            </button>
            <div id="email-send-status" class="status-message" style="display: none;"></div>
        </div>
    </section>
</div>

<script>
// Today's date for default
const today = new Date().toISOString().split('T')[0];
document.getElementById('gameday-date').value = today;

// Update Stats Button with Real-Time Progress
let activeEventSource = null;
let activeCheckInterval = null;

// Cleanup function for update stats
function cleanupUpdateStats() {
    if (activeEventSource) {
        activeEventSource.close();
        activeEventSource = null;
    }
    if (activeCheckInterval) {
        clearInterval(activeCheckInterval);
        activeCheckInterval = null;
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', cleanupUpdateStats);

document.getElementById('btn-update-stats').addEventListener('click', async function() {
    const button = this;
    const status = document.getElementById('update-status');
    const progressBox = document.getElementById('update-progress');
    const currentItem = document.getElementById('update-current-item');

    // Clean up any existing connections
    cleanupUpdateStats();

    button.disabled = true;
    button.textContent = '‚è≥ Updating... (10-15 minutes)';
    status.style.display = 'block';
    status.className = 'status-message status-loading';
    status.textContent = 'Starting update...';
    progressBox.style.display = 'block';

    // Generate unique session ID
    const sessionId = 'update-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

    try {
        // First, start the update task
        const response = await fetch('/api/update-stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Update failed');
        }

        // Task started successfully, now connect to SSE for progress
        status.textContent = 'Update started, receiving progress...';

        activeEventSource = new EventSource(`/api/progress/${sessionId}`);
        let lastMessageTime = Date.now();
        let errorCount = 0;
        let completedSuccessfully = false;

        activeCheckInterval = setInterval(() => {
            const timeSinceLastMessage = Date.now() - lastMessageTime;
            if (timeSinceLastMessage > 60000) {
                console.warn('No activity for 60 seconds, connection may be dead');
                currentItem.textContent = '‚è≥ Still updating... (no recent activity)';
            }
        }, 10000);

        activeEventSource.onmessage = function(event) {
            lastMessageTime = Date.now();
            try {
                const message = JSON.parse(event.data);

                if (message.type === 'info' || message.type === 'fetch') {
                    currentItem.textContent = message.message;
                } else if (message.type === 'warning') {
                    currentItem.textContent = '‚ö†Ô∏è ' + message.message;
                } else if (message.type === 'error') {
                    currentItem.textContent = '‚ùå ' + message.message;
                    status.className = 'status-message status-error';
                    status.textContent = `‚ùå Error: ${message.message}`;
                    button.textContent = 'üîÑ Update All Stats';
                    button.disabled = false;
                    progressBox.style.display = 'none';
                    cleanupUpdateStats();
                } else if (message.type === 'success') {
                    completedSuccessfully = true;
                    currentItem.textContent = message.message;
                    status.className = 'status-message status-success';
                    status.textContent = '‚úÖ All stats updated successfully!';
                    button.textContent = '‚úÖ Update Complete';
                    setTimeout(() => {
                        progressBox.style.display = 'none';
                        button.textContent = 'üîÑ Update All Stats';
                        button.disabled = false;
                        cleanupUpdateStats();
                    }, 3000);
                }
            } catch (parseError) {
                console.error('Failed to parse SSE message:', parseError);
            }
        };

        activeEventSource.onerror = function(err) {
            if (completedSuccessfully) {
                console.log('SSE stream closed after successful completion (expected)');
                cleanupUpdateStats();
                return;
            }

            errorCount++;
            console.error('SSE error (count: ' + errorCount + '):', err);

            if (errorCount > 3) {
                currentItem.textContent = 'Connection error - update may still be running in background';
                status.className = 'status-message status-error';
                status.textContent = '‚ùå Connection lost - update may still be running. Check logs or try again later.';
                button.textContent = 'üîÑ Update All Stats';
                button.disabled = false;
                progressBox.style.display = 'none';
                cleanupUpdateStats();
            }
        };

    } catch (error) {
        currentItem.textContent = 'Failed to start update';
        status.className = 'status-message status-error';
        status.textContent = `‚ùå Error: ${error.message}`;
        button.textContent = 'üîÑ Update All Stats';
        button.disabled = false;
        progressBox.style.display = 'none';
        cleanupUpdateStats();
    }
});

// Simulate Gameday Button
document.getElementById('btn-simulate-gameday').addEventListener('click', async function() {
    const button = this;
    const status = document.getElementById('gameday-status');
    const results = document.getElementById('gameday-results');
    const date = document.getElementById('gameday-date').value;

    button.disabled = true;
    button.textContent = '‚è≥ Simulating...';
    status.style.display = 'block';
    status.className = 'status-message status-loading';
    status.textContent = 'Checking games and milestones...';
    results.style.display = 'none';

    try {
        const response = await fetch('/api/simulate-gameday', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: date })
        });

        const data = await response.json();

        if (data.success) {
            status.className = 'status-message status-success';
            status.textContent = '‚úÖ Simulation complete!';

            // Update summary
            document.getElementById('games-count').textContent = data.games_count;
            document.getElementById('milestones-count').textContent = data.proximities_count;
            document.getElementById('pr-count').textContent = data.pr_breakthroughs_count || 0;
            document.getElementById('sports-list').textContent = data.sports_with_games.join(', ') || 'None';

            // Display games
            const gamesList = document.getElementById('games-list');
            if (data.games.length > 0) {
                gamesList.innerHTML = data.games.map(game => `
                    <div class="result-item">
                        <strong>${game.sport}</strong> vs ${game.opponent} (${game.location})<br>
                        Time: ${game.time}
                    </div>
                `).join('');
            } else {
                gamesList.innerHTML = '<p class="empty">No games scheduled</p>';
            }

            // Display milestones
            const milestonesList = document.getElementById('milestones-list');
            if (data.proximities.length > 0) {
                milestonesList.innerHTML = data.proximities.map(prox => `
                    <div class="result-item">
                        <strong>${prox.player_name}</strong><br>
                        ${prox.milestone}<br>
                        Current: ${prox.current} | Target: ${prox.target} | Remaining: ${prox.remaining} (${prox.percentage})
                    </div>
                `).join('');
            } else {
                milestonesList.innerHTML = '<p class="empty">No players close to milestones</p>';
            }

            // Display PR breakthroughs
            const prList = document.getElementById('pr-list');
            if (data.pr_breakthroughs && data.pr_breakthroughs.length > 0) {
                prList.innerHTML = data.pr_breakthroughs.map(pr => `
                    <div class="result-item">
                        <strong>${pr.athlete_name}</strong> - ${pr.event}<br>
                        Previous: ${pr.old_pr} ‚Üí New PR: <strong>${pr.new_pr}</strong> (‚Üì ${pr.improvement})<br>
                        <em>at ${pr.meet_name}</em>
                    </div>
                `).join('');
            } else {
                prList.innerHTML = '<p class="empty">No PR breakthroughs (sample data shown in email preview)</p>';
            }

            // Display email preview
            document.getElementById('email-subject').textContent = data.email_subject;
            document.getElementById('email-preview').innerHTML = data.email_html;

            results.style.display = 'block';
            button.textContent = 'üìÖ Simulate Gameday';
            button.disabled = false;
        } else {
            throw new Error(data.error || 'Simulation failed');
        }
    } catch (error) {
        status.className = 'status-message status-error';
        status.textContent = `‚ùå Error: ${error.message}`;
        button.textContent = 'üìÖ Simulate Gameday';
        button.disabled = false;
    }
});

// Send Test Email Button
document.getElementById('btn-send-test-email').addEventListener('click', async function() {
    const button = this;
    const status = document.getElementById('email-send-status');
    const date = document.getElementById('gameday-date').value;

    if (!confirm('Send test email to configured recipients?')) {
        return;
    }

    button.disabled = true;
    button.textContent = '‚è≥ Sending...';
    status.style.display = 'block';
    status.className = 'status-message status-loading';
    status.textContent = 'Sending email...';

    try {
        const response = await fetch('/api/send-test-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: date })
        });

        const data = await response.json();

        if (data.success) {
            status.className = 'status-message status-success';
            status.textContent = '‚úÖ Email sent successfully!';
        } else {
            throw new Error(data.error || 'Email send failed');
        }
    } catch (error) {
        status.className = 'status-message status-error';
        status.textContent = `‚ùå Error: ${error.message}`;
    } finally {
        button.textContent = '‚úâÔ∏è Send Test Email';
        button.disabled = false;
    }
});
</script>
{% endblock %}
